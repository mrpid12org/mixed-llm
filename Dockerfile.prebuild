# This is a temporary Dockerfile just for building the Open WebUI frontend once.
FROM nvidia/cuda:12.8.1-devel-ubuntu22.04 AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    git ca-certificates gnupg cmake \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && NODE_MAJOR=20 \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_$NODE_MAJOR.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install nodejs -y \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app
RUN git clone --depth 1 --branch v0.6.23 https://github.com/open-webui/open-webui.git .

RUN NODE_OPTIONS="--max-old-space-size=16384" npm install --legacy-peer-deps && \
    npm install lowlight --legacy-peer-deps && \
    npm install y-protocols --legacy-peer-deps && \
    npm install @tiptap/suggestion --legacy-peer-deps && \
    npm run build

# We add a final command to keep the container alive if needed, but we won't actually run it.
CMD ["tail", "-f", "/dev/null"]
