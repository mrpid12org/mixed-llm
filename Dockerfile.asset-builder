# Use an official Node.js image as the base. Version 20 is standard.
FROM node:20-bookworm

# Install git, which is needed to clone the source repository
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Set the working directory to the repository root
WORKDIR /app

# Clone the specific version of the Open WebUI repository
RUN git clone --depth=1 --branch v0.6.23 https://github.com/open-webui/open-webui.git .

# ✅ FIX: Run all npm commands from the project root /app, just like the original Dockerfile.
# This ensures the build output goes to the correct directory (/app/build).
RUN npm install --legacy-peer-deps && \
    npm install @tiptap/suggestion --legacy-peer-deps && \
    npm install lowlight --legacy-peer-deps && \
    npm install y-protocols --legacy-peer-deps

# Now, run the production build.
RUN npm run build

# Create a staging directory to cleanly package our assets
RUN mkdir -p /release_assets/backend

# ✅ FIX: Copy the frontend from the correct build output directory (/app/build)
RUN cp -R /app/build /release_assets/
RUN cp -R /app/backend/* /release_assets/backend/

# Create the final compressed archive in the root of the image
RUN tar -czvf /webui-v0.6.23.tar.gz -C /release_assets .

# A simple command to indicate the build is done.
CMD ["echo", "Asset build complete. The artifact is available at /webui-v0.6.23.tar.gz"]
